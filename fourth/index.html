<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>实现bind/apply/call | JS进阶</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="">
    <link rel="preload" href="/advancedjs/assets/css/0.styles.8fa1a859.css" as="style"><link rel="preload" href="/advancedjs/assets/js/app.77b2bcfa.js" as="script"><link rel="preload" href="/advancedjs/assets/js/2.8583cbae.js" as="script"><link rel="preload" href="/advancedjs/assets/js/6.393d834f.js" as="script"><link rel="prefetch" href="/advancedjs/assets/js/3.11572a76.js"><link rel="prefetch" href="/advancedjs/assets/js/4.7d5f245c.js"><link rel="prefetch" href="/advancedjs/assets/js/5.d2c494c7.js"><link rel="prefetch" href="/advancedjs/assets/js/7.47b2562a.js"><link rel="prefetch" href="/advancedjs/assets/js/8.ee7c82b9.js">
    <link rel="stylesheet" href="/advancedjs/assets/css/0.styles.8fa1a859.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar"><!----> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/advancedjs/first/" class="sidebar-link">第一章-异步编程（异步方案概览）</a></li><li><a href="/advancedjs/second/" class="sidebar-link">第二章-手写promise</a></li><li><a href="/advancedjs/third/" class="sidebar-link">第三章- promise.all 的并发限制</a></li><li><a href="/advancedjs/fourth/" aria-current="page" class="active sidebar-link">第四章-实现bind/apply/call</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/advancedjs/fourth/#实现bind代码" class="sidebar-link">实现bind代码</a></li><li class="sidebar-sub-header"><a href="/advancedjs/fourth/#支持-new-的-bind" class="sidebar-link">支持 new 的 bind</a></li><li class="sidebar-sub-header"><a href="/advancedjs/fourth/#实现call" class="sidebar-link">实现call</a></li><li class="sidebar-sub-header"><a href="/advancedjs/fourth/#实现apply" class="sidebar-link">实现apply</a></li><li class="sidebar-sub-header"><a href="/advancedjs/fourth/#小结" class="sidebar-link">小结</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="实现bind-apply-call"><a href="#实现bind-apply-call" class="header-anchor">#</a> 实现bind/apply/call</h1> <h2 id="实现bind代码"><a href="#实现bind代码" class="header-anchor">#</a> 实现bind代码</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">myBind</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  args <span class="token operator">=</span> args <span class="token operator">?</span> args <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>newFnArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">,</span> <span class="token operator">...</span>newFnArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>函数也是可以调用函数的，比如f1.bind()，自然bind的this就是函数</li> <li>bind是返回一个绑定好的函数</li> <li>参数一但传进来变成函数词法环境静态的一部分，不会改变的，所以达到了绑定的效果</li></ul> <h2 id="支持-new-的-bind"><a href="#支持-new-的-bind" class="header-anchor">#</a> 支持 new 的 bind</h2> <p>要让bind返回的函数支持new操作，new操作会做下面四件事</p> <ol><li>创建空对象obj</li> <li><code>obj.__proto__ = F1.prototype</code></li> <li>F1.call(obj)</li> <li>return obj</li></ol> <p>注意事项：</p> <ul><li>如果构造函数自带return，那么new的return obj不会实现</li> <li>对于 new 来说， bind 绑定的 this 不影响构造函数里的 this。</li> <li><code>let f1 = F1.bind(undefined,xxx)</code></li></ul> <p>我们现在要让 f1 支持 new：</p> <ul><li><code>new f1</code> 由于源代码是返回一个函数调用导致new的时候无法返回实例对象，所以我们要判断当f1函数（bind返回的函数）前加new时，要返回一个实例。</li> <li>我们根据new的四个过程发现f1.call(obj)和<code>obj.__proto__ = F1.prototype</code> 所以添加判断this instanceof newFn</li> <li>但是我们想要的是fn的原型而不是newFn的原型</li> <li>我们new的其实是newFn但是返回的却是new fn，根据new newFn来判断this instanceof newFn，判断成功返回new fn，new newFn只是缺少了四步new过程的最后一步而已。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">myBind</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token keyword">this</span>
    args <span class="token operator">=</span> args <span class="token operator">?</span> args <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">newFn</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>newFnArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">newFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span> <span class="token operator">...</span>newFnArgs<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">...</span>args<span class="token punctuation">,</span><span class="token operator">...</span>newFnArgs<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="实现call"><a href="#实现call" class="header-anchor">#</a> 实现call</h2> <p>this拿到f.call的f函数，context.this来调用函数</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">function</span> <span class="token function">myCall</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context <span class="token operator">=</span> context <span class="token operator">||</span> window
    args <span class="token operator">=</span> args <span class="token operator">?</span> args <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    context<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> context<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token keyword">delete</span> context<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre></div><h2 id="实现apply"><a href="#实现apply" class="header-anchor">#</a> 实现apply</h2> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token function-variable function">myApply</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">myApply</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context <span class="token operator">=</span> context <span class="token operator">||</span> window
    args <span class="token operator">=</span> args <span class="token operator">?</span> args <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    context<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> context<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token keyword">delete</span> context<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre></div><p>因为context是别人传过来的</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <ul><li>call实现总结：this只有在调用时才知道，所以使用this拿到f，用context调用f即可===&gt;context[key] = f</li> <li>bind实现技术总结：利用参数传进来的this不会改变，利用call调用即可</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/advancedjs/third/" class="prev">
        第三章- promise.all 的并发限制
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/advancedjs/assets/js/app.77b2bcfa.js" defer></script><script src="/advancedjs/assets/js/2.8583cbae.js" defer></script><script src="/advancedjs/assets/js/6.393d834f.js" defer></script>
  </body>
</html>
